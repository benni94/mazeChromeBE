<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Progress Data</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container" id="tableContainer">
        <table>
            <thead>
                <tr>
                    <th>Platzierung</th>
                    <th>Name</th>
                    <th>verw. Funktionen</th>
                    <th>Funktionen ges.</th>
                    <th>Spielzeit</th>
                    <th>Uhrzeit</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Table rows will be inserted dynamically by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('tableContainer');
            let userActive = true;
            let scrollingActive = false;
            let scrollDirection = 1; // 1 for down, -1 for up
            let scrollInterval;
            let inactivityTimer;

            // Function to start auto-scrolling
            function startAutoScroll() {
                if (scrollingActive) return;

                scrollingActive = true;
                scrollInterval = setInterval(() => {
                    // Scroll by 1 pixel in the current direction
                    container.scrollBy({
                        top: scrollDirection,
                        behavior: 'auto'
                    });

                    // Check if we've reached the bottom or top
                    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 5) {
                        scrollDirection = -1; // Switch to scrolling up
                    } else if (container.scrollTop <= 5) {
                        scrollDirection = 1; // Switch to scrolling down
                    }
                }, 30); // Adjust speed by changing this value
            }

            // Function to stop auto-scrolling
            function stopAutoScroll() {
                if (!scrollingActive) return;

                scrollingActive = false;
                if (scrollInterval) {
                    clearInterval(scrollInterval);
                    scrollInterval = null;
                }
            }

            // Reset inactivity timer when user interacts
            function resetInactivityTimer() {
                userActive = true;
                stopAutoScroll();

                if (inactivityTimer) {
                    clearTimeout(inactivityTimer);
                }

                inactivityTimer = setTimeout(() => {
                    userActive = false;
                    startAutoScroll();
                }, 5000); // 5 seconds of inactivity
            }

            // Set up event listeners for user activity
            ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer, { passive: true });
            });

            // Initial setup for auto-scroll
            resetInactivityTimer();

            // Function to convert time to seconds for sorting
            function timeToSeconds(timeStr) {
                if (!timeStr || timeStr === '00:00:00') return Number.MAX_SAFE_INTEGER;
                const [hours, minutes, seconds] = timeStr.split(':').map(Number);
                return hours * 3600 + minutes * 60 + seconds;
            }

            // Function to refresh the table data
            function refreshData() {
                fetch('/api/gamedata')
                    .then(response => response.json())
                    .then(data => {
                        // Sort the data
                        data.sort((a, b) => {
                            // Put "00:00:00" at the bottom
                            if (a.completion_time_formatted === '00:00:00') return 1;
                            if (b.completion_time_formatted === '00:00:00') return -1;

                            return timeToSeconds(a.completion_time_formatted) - timeToSeconds(b.completion_time_formatted);
                        });

                        // Update the table
                        const tableBody = document.getElementById('tableBody');
                        tableBody.innerHTML = ''; // Clear existing rows

                        data.forEach((row, i) => {
                            let functionDetails;
                            try {
                                const parsed = JSON.parse(row.function_details);
                                functionDetails = JSON.stringify(parsed, null, 2);
                            } catch (e) {
                                functionDetails = row.function_details || '';
                            }

                            const timeOnly = row.timestamp ? (row.timestamp.split(', ')[1] || row.timestamp) : '';

                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                <td class="xxx-large">${i + 1}.</td>
                <td class="xx-large">${row.name || ''}</td>
                <td class="function-details"><pre>${functionDetails}</pre></td>
                <td class="x-large">${row.total_functions || 0}</td>
                <td>${row.completion_time_formatted || ''}</td>
                <td>${timeOnly}</td>
              `;

                            tableBody.appendChild(tr);
                        });
                    })
                    .catch(error => console.error('Error refreshing data:', error));
            }

            // Initial data load
            refreshData();

            // Refresh every second
            setInterval(refreshData, 1000);
        });
    </script>
</body>

</html>